<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>
<body>
<div class="container" style="margin-top: 2em">
    <!-- Search product input -->
    <div class="mb-3">
        <form id="searchForm" action="/products/search" method="get" class="form-inline my-2 my-lg-0">
            <div style="display: flex; justify-content: center;">    
                <input
                id="searchedData"
                class="form-control mr-sm-2 mb-2 mt-2 mx-3"
                type="search"
                placeholder="Search Product"
                aria-label="Search"
                name="productSearch"
                />
                <button
                class="btn btn-outline-primary my-1 my-sm-2 mx-3"
                type="submit"
                >
                Search
                </button>
            </div>
        </form>
    </div>
    <!-- End search product input -->

    <!-- Dropdown for categories -->
    <div class="mb-3" style="display: flex; justify-content: center;">
        <select class="form-select" style="max-width: 30em; " id="categorySelect" onchange="navigateToCategory(this);">
            
        </select>
    </div>

    <div style="display: flex;">
        <div style="flex-grow: 1;"><h3 style="margin-bottom: 1em">All Products</h3></div>
        <div style="justify-content: flex-end;"><button class="btn btn-primary" onclick="window.location.href='/categories'" >Back to Categories</button></div>
        <div style="justify-content: flex-end; margin-left: 1em;"><button onclick="window.history.back()" class="btn btn-outline-primary"> Back</button></div>
    </div>


        <!-- Products Table -->
        <table border="1" id="products-table" class="table table-striped">
            <thead style="background-color: rgb(58, 58, 58); color: white">
                <tr>
                    <th scope="col">Product ID</th>
                    <th scope="col">Product Name</th>
                    <th scope="col">Brand</th>
                    <th scope="col">Price</th>
                    <th scope="col">Discounted Price</th>
                    <th scope="col">Created Date</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <!-- Pagination -->
        <div class="container">
            <nav aria-label="Page navigation example">
                <ul class="pagination" id="pagination">
                </ul>
            </nav>
        </div>
        <!-- End Pagination -->
</div>

    <script>
        // Function to fetch data from the endpoint URL
        async function fetchData(url) {
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Function to render category options in dropdown
        async function renderCategoryOptions(categories) {
            const select = document.getElementById('categorySelect');
            const data = await fetchData('/api/all-products'); // Fetch categories
            const selectedCategoryId = select.value; // Preserve the selected category ID

            // Clear existing options only if categories are available
            if (data.categories.length > 0) {
                select.innerHTML = '<option value="">Select a category</option>';
            }

            data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.cat_id;
                option.textContent = category.cat_name;
                if (category.cat_id === selectedCategoryId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }


        // Function to render products table
        function renderProducts(products) {
            const tbody = document.querySelector('#products-table tbody');
            tbody.innerHTML = '';
            products.forEach(product => {
                const row = `
                    <tr>
                        <td>${product.prod_id}</td>
                        <td>${product.prod_name}</td>
                        <td>${product.prod_brand}</td>
                        <td>${product.price}</td>
                        <td>${product.discounted_price}</td>
                        <td>${new Date(product.created_date).toLocaleDateString()}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Function to render pagination
        function renderPagination(totalPages, currentPage) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // Previous button
            const previousLi = document.createElement('li');
            previousLi.classList.add('page-item');
            if (currentPage === 1) {
                previousLi.classList.add('disabled');
            }
            const previousLink = document.createElement('a');
            previousLink.classList.add('page-link');
            previousLink.href = `/all-products?page=${currentPage - 1 > 0 ? currentPage - 1 : 1}`;
            previousLink.textContent = 'Previous';
            previousLi.appendChild(previousLink);
            pagination.appendChild(previousLi);

            // Page buttons
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.classList.add('page-item');
                if (i === currentPage) {
                    li.classList.add('active');
                }
                const link = document.createElement('a');
                link.classList.add('page-link');
                link.href = `/all-products?page=${i}`;
                link.textContent = i;
                li.appendChild(link);
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.classList.add('page-item');
            if (currentPage === totalPages) {
                nextLi.classList.add('disabled');
            }
            const nextLink = document.createElement('a');
            nextLink.classList.add('page-link');
            nextLink.href = `/all-products?page=${currentPage + 1 <= totalPages ? currentPage + 1 : totalPages}`;
            nextLink.textContent = 'Next';
            nextLi.appendChild(nextLink);
            pagination.appendChild(nextLi);
        }



        // Function to handle page load
        async function onPageLoad() {
            const urlParams = new URLSearchParams(window.location.search);
            console.log(urlParams);
            const categoryId = urlParams.get('categoryId') || '';
            const currentPage = parseInt(urlParams.get('page')) || 1;
            const url = `/api/all-products?page=${currentPage}`;
            const data = await fetchData(url);
            renderProducts(data.products);
            renderPagination(data.totalPages, data.currentPage);
            renderCategoryOptions();
        }
        // Function to handle navigation to a category
        function navigateToCategory(select) {
            const selectedOption = select.options[select.selectedIndex];
            const categoryId = selectedOption.value;
            window.location.href = `/product/${categoryId}`;
        }

        // Call onPageLoad when the page is loaded
        window.onload = onPageLoad;
    </script>
</body>
</html>
